{% extends 'base.html' %}
{% load static %}

{% block title %}
{{post.title}}
{% endblock title %}

{% block head %}
{% endblock head %}

{% block content %}

{{ post.title }}
{% for facility in facilities %}
{{ facility }}
{% endfor %}
<div class="map" id="map" style="width:400px; height:400px;" data-longitude="{{ longitude }}" data-latitude="{{ latitude }}"></div>

{% comment %} 리뷰 {% endcomment %}
<a href="{% url 'reviews:create' post.pk %}">리뷰 작성</a>
<p>리뷰수 - {{ reviews|length }}</p>
{% for review in reviews %}

  {% comment %} 리뷰 수정, 삭제 {% endcomment %}
  <div>
    {% if request.user == review.user %}
      <a href="{% url 'reviews:update' review.pk %}">리뷰수정</a>
      <form action="{% url 'reviews:delete' review.pk %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="삭제">
      </form>
    {% endif %}
  </div>
  {% comment %} 프로필 {% endcomment %}
  <div>
    <a href="{% url 'accounts:profile' review.user %}">
      {% if review.user.image %}
        <img src="{{ review.user.image.url }}" alt="">
      {% else %}
      <img src="{% static 'profile_no_image.png' %}" alt="">
      {% endif %}
      <p>{{ review.user}}</p>
    </a>
  </div>

  {% comment %} rating {% endcomment %}
  <div>
    {{ review.rate_to_star }}{{ review.rate_to_empty_star}}
  </div>
  <div>
    {{ review.created_string }}
    {{ review.title }}
    {{ review.content }}
  </div>

  {% comment %} emote {% endcomment %}
  
    <div class="d-flex">
      <form class="review-like-forms d-flex" data-review-id="{{ review.pk }}">
        {% csrf_token %}
        <button type="submit" class="btn-like" id="review-like-{{ review.pk }}">
          {% if request.user.is_authenticated and review.like_exist %}
          <i class="bi bi-hand-thumbs-up-fill text-orange"></i> 
          <span>{{ review.likes|length }}</span>
          {% else %}
          <i class="bi bi-hand-thumbs-up"></i>
          <span>{{ review.likes|length }}</span>
          {% endif %}
        </button>
      </form>
      <form class="review-dislike-forms d-flex" data-review-id="{{ review.pk }}">
        <button type="submit" class="btn-dislike" id="review-dislike-{{ review.pk }}">
          {% if request.user.is_authenticated and review.dislike_exist %}
          <i class="bi bi-hand-thumbs-down-fill text-orange"></i> 
          <span>{{ review.dislikes|length }}</span>
          {% else %}
          <i class="bi bi-hand-thumbs-down"></i>
          <span>{{ review.dislikes|length }}</span> 
          {% endif %}
        </button>
      </form>
    </div>
 


{% endfor %}
{% endblock content %}

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_script_key }}&libraries=services"></script>
<script src="{% static '/js/posts_detail_map.js' %}" type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // 비동기 리뷰 좋아요/싫어요
  const reviewLikeForms = document.querySelectorAll('.review-like-forms')
  const reviewDislikeForms = document.querySelectorAll('.review-dislike-forms')

  reviewLikeForms.forEach((form) => {
    form.addEventListener('submit', (event) => {
      event.preventDefault()
      
      const reviewId = event.target.dataset.reviewId
      axios({
        method: 'post',
        url: `/reviews/${ reviewId }/emotes/1/`,
        headers: {'X-CSRFToken': csrftoken,},
      })
      .then((response) => {
        const isChecked = response.data.is_checked
        const emoteCnt = response.data.cnt
        const isAlert = response.data.alert
        const iTag = document.querySelector(`#review-like-${ reviewId }>i`)
        const cntSpanTag = document.querySelector(`#review-like-${ reviewId }>span`)

        if (isChecked === undefined) {
          // 경고창
          alert('로그인 후 이용해주세요.')
        } else if (isAlert) {
          alert('이미 싫어요를 눌렀습니다.')
        } else if (isChecked) {
          iTag.classList.replace('bi-hand-thumbs-up', 'bi-hand-thumbs-up-fill')
          iTag.classList.add('text-orange')
          cntSpanTag.textContent = emoteCnt
        } else {
          iTag.classList.replace('bi-hand-thumbs-up-fill', 'bi-hand-thumbs-up')
          iTag.classList.remove('text-orange')
          cntSpanTag.textContent = emoteCnt
        }
      })
      .catch((error) => {
        console.log(error.response)
      })
    })
  })
  reviewDislikeForms.forEach((form) => {
    form.addEventListener('submit', (event) => {
      event.preventDefault()
      
      const reviewId = event.target.dataset.reviewId
      axios({
        method: 'post',
        url: `/reviews/${ reviewId }/emotes/2/`,
        headers: {'X-CSRFToken': csrftoken,},
      })
      .then((response) => {
        const isChecked = response.data.is_checked
        const emoteCnt = response.data.cnt
        const isAlert = response.data.alert
        const iTag = document.querySelector(`#review-dislike-${ reviewId }>i`)
        const cntSpanTag = document.querySelector(`#review-dislike-${ reviewId }>span`)

        console.log(emoteCnt)

        if (isChecked === undefined) {
          // 경고창
          alert('로그인 후 이용해주세요.')
        } else if (isAlert) {
          alert('이미 좋아요를 눌렀습니다.')
        } else if (isChecked) {
          iTag.classList.replace('bi-hand-thumbs-down', 'bi-hand-thumbs-down-fill')
          iTag.classList.add('text-orange')
          cntSpanTag.textContent = emoteCnt
        } else {
          iTag.classList.replace('bi-hand-thumbs-down-fill', 'bi-hand-thumbs-down')
          iTag.classList.remove('text-orange')
          cntSpanTag.textContent = emoteCnt
        }
      })
      .catch((error) => {
        console.log(error.response)
      })
    })
  })
  
</script>


{% endblock script %}