{% extends "base.html" %}
{% load static %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock head %}

{% block style %}
<style>
  .city--box {
    display: flex;
    margin: 5rem;
  }

  .city--box__camps {
    display:flex;
  }

  .city--box__camp {
    display: flex;
    flex-direction: column;
    margin: 1rem;
  }
</style>
{% endblock style %}

{% block content %}

  <div class="city--box">
    {% comment %} 선호지역 지도 {% endcomment %}
    <div class="map" id="map" style="width:400px; height:400px;"></div>
  
    <div class="city--box__camps">
      {% for campsite in campsites %}
      <div class="city--box__camp">
        <p>{{ campsite.title }}</p>
        <p>{{ campsite.content }}</p>
        <p>{{ campsite.address }}</p>
      </div>
      {% endfor %}
    </div>
  </div>


{% endblock content %}

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_script_key }}&libraries=services"></script>
<script>
  const API_KEY = "{{ kakao_key }}";
  kakao.maps.load(() => {
    const mapContainer = document.getElementById('map');
    const mapOptions = {
      center: new kakao.maps.LatLng(0, 0),
      level: 8,
    };

    const map = new kakao.maps.Map(mapContainer, mapOptions);
    const geocoder = new kakao.maps.services.Geocoder();
    const coordinates = [];

    {% for campsite in campsites %}
    axios.get(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent("{{ campsite.address }}")}`, {
      headers: {
        Authorization: `KakaoAK ${API_KEY}`,
      },
    })
      .then((response) => {
        const result = response.data.documents[0];
        const latitude = result.y;
        const longitude = result.x;

        coordinates.push(new kakao.maps.LatLng(latitude, longitude));

        const markerPosition = new kakao.maps.LatLng(latitude, longitude);
        const marker = new kakao.maps.Marker({
          position: markerPosition,
          map: map,
          title: "{{ campsite.title }}",
        });

        kakao.maps.event.addListener(marker, 'click', function() {
          window.location.href = '/posts/{{ campsite.id }}';
        });

        if (coordinates.length === {{ campsites|length }}) {
          const center = getCenterCoordinate(coordinates);
          map.setCenter(center);
        }
      })
      .catch((error) => {
        console.log(error);
      });
    {% endfor %}
  });

  function getCenterCoordinate(coordinates) {
    let totalLat = 0;
    let totalLng = 0;
    for (let i = 0; i < coordinates.length; i++) {
      totalLat += coordinates[i].getLat();
      totalLng += coordinates[i].getLng();
    }
    const averageLat = totalLat / coordinates.length;
    const averageLng = totalLng / coordinates.length;
    return new kakao.maps.LatLng(averageLat, averageLng);
  }
</script>
{% endblock script %}